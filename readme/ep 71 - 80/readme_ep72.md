# Nuxt 3 CMS Stock Course EP.72 - Workshop - Frontend - Auth store (Login and Register)

## Outcome

-   [x] Use `auth` store
-   [x] Create `response` for `register` and `login``

## Documentation for this episode

-   X

## Setup

1. Create `login.response.ts` in `~/types/responses/login.response.ts`

```ts
// ~/types/response/register.ts
// Generated by https://quicktype.io

export type LoginResponse = {
    result: string;
    data: Data;
};

export type Data = {
    username: string;
    level: string;
    createdAt: string;
    updatedAt: string;
};
```

2. Update `auth-api.service.ts` in `~/services/api/auth-api.service.ts`

```ts
const result = (await fetch(`${server.LOGIN_URL}`, {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
    },
    body: JSON.stringify(loginDto),
})) as Promise<LoginResponse>; // <-- Update this line
```

3. Update `auth.store.ts` in `~/store/auth.store.ts`

```ts
import type { LoginDto } from "~/types/dtos/login.dto";
import type { RegisterDto } from "~/types/dtos/register.dto";
import { FetchingStatus } from "~/types/enums/FetchingStatus";
import { TSession } from "~/types/session.type";

export const useAuthStore = defineStore("auth", () => {
    const username = useCookie(server.TOKEN_KEY);
    const token = useCookie(server.TOKEN_KEY);
    const fetchingStatus = ref<FetchingStatus>(FetchingStatus.init);
    const session = reactive<TSession>({ isLoggedIn: false });
    const router = useRouter();
    const api = useApi();

    const login = async (loginDto: LoginDto) => {
        try {
            fetchingStatus.value = FetchingStatus.fetching;
            await new Promise((resolve) => setTimeout(resolve, 1000));
            const { result, data } = await api.login(loginDto);
            if (result === "ok") {
                session.username = data.username;
                session.isLoggedIn = true;
                fetchingStatus.value = FetchingStatus.success;
                message.success("Login successful");
                console.log("ล็อคอินสำเร็จ");
            } else {
                session.isLoggedIn = false;
                fetchingStatus.value = FetchingStatus.failed;
                message.error("Login Failed");
            }
            window.open("/stock", "_self");
        } catch (e) {
            console.log(e);

            session.isLoggedIn = false;
            fetchingStatus.value = FetchingStatus.failed;
            message.error("Something went wrong");
        }
    };

    const register = async (registerDto: RegisterDto) => {
        try {
            fetchingStatus.value = FetchingStatus.fetching;
            await new Promise((resolve) => setTimeout(resolve, 1000));
            const result = await api.register(registerDto);
            if (result == true) {
                fetchingStatus.value = FetchingStatus.success;
                message.success("Register successful");
                return await navigateTo("/login", { redirectCode: 301 });
            } else {
                fetchingStatus.value = FetchingStatus.failed;
                message.error("Register Failed");
            }
        } catch (e) {
            fetchingStatus.value = FetchingStatus.failed;
            message.error("Something went wrong");
        }
    };
    return {
        login,
        register,
    };
});
```

4. Update `login.vue` on `script` in `~/pages/login.vue`

```vue
<script setup lang="ts">
const authStore = useAuthStore();
const onSubmit = () => {
    validate()
        .then(async () => {
            await authStore.login(toRaw(modelRef));
        })
        .catch((err) => {
            console.log("error", err);
        });
};
</script>
```

5. Update `register.vue` on `script` in `~/pages/register.vue`

```vue
<script setup lang="ts">
const onSubmit = () => {
    validate()
        .then(async () => {
            await authStore.register(toRaw(modelRef));
        })
        .catch((err) => {
            console.log("error", err);
        });
};
</script>
```
